# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|

  config.vm.box = "debian/stretch64"
  config.vm.hostname = "zeus"

  config.vm.define "zeus" do |node|
    node.vm.provider :lxc do |lxc|
      lxc.container_name = :machine
      lxc.backingstore = 'best'
      lxc.fetch_ip_tries = 30
      lxc.customize "network.type", "veth"
      lxc.customize "network.link", "virbr1"
      lxc.customize "network.flags", "up"
    end
  end

  config.vm.provision "file", source: "~/local/keepass/ambassador.kdbx", destination: "~/local/keepass/ambassador.kdbx"
  config.vm.provision "file", source: "~/local/keys/ambassador.key", destination: "~/local/keys/ambassador.key"
  config.vm.provision "file", source: "~/local/keys/cfg_ro.key", destination: "~/local/keys/cfg_ro"
  config.vm.provision "file", source: "~/local/keys/cfg_ro.key.pub", destination: "~/local/keys/cfg_ro.pub"
  config.vm.provision "file", source: "~/local/keys/pillargpg.gpg", destination: "~/local/keys/pillargpg.gpg"
  config.vm.provision "file", source: "~/local/keys/pillargpg.gpg.pub", destination: "~/local/keys/pillargpg.gpg.pub"

  config.vm.provision "salt deps", type: "shell", env: {"SHELL": "/bin/bash"} do |s|
    s.path = "https://gist.githubusercontent.com/kiemlicz/1aa8c2840f873b10ecd744bf54dcd018/raw/c3a41412272e15f8687f312af63088a8d3938182/setup_salt_requisites.sh"
  end
  config.vm.provision "salt keys", type: "shell", env: {"SHELL": "/bin/bash"} do |s|
    s.inline = <<-SHELL
        # must be installed here since masterless run may require it...
        pip3 install --upgrade pykeepass
        gpg --homedir /etc/salt/gpgkeys --import /home/vagrant/local/keys/pillargpg.gpg
    SHELL
  end
# todo saltutil.sync_all must be performed first...
  config.vm.provision :salt do |salt|
    salt.masterless = true
    salt.run_highstate = true
    salt.minion_config = "minion-zeus.conf"
    salt.bootstrap_options = "-x python3"
    salt.python_version = 3
  end
end
