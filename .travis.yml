language: generic
# in order not to use virtualenv

sudo: required

dist: bionic

services:
  - docker
  - redis

env:
  global:
    - SALT_VER="" # use "" for latest stable, other options: "git 2019.2.2"
    - COMPOSE_VER="1.22.0"
    - KUBECTL_VER="v1.17.3"
    - PIP3_PYGIT2_VER="1.0.3"
    - PIP3_KUBERNETES_VER="10.0.1"
    - GH_URL="https://kiemlicz.github.io/ambassador/"
    - BUILD_DIR=".local"
    - CHART_BRANCH="gh-pages"
    - BASE_PUB_NAME="envoy"
    - K8S_API_ENABLED=true

jobs:
  allow_failures:
    - env:
        - DOCKER_IMAGE=fedora-31
        - CONTEXT=syntax-test
        - TEST=syntax
      before_install: .travis/prepare.sh salt-test
      script: .travis/test.sh salt-test
  include:
    - stage: test
      name: "Test and publish"
      env:
        - DOCKER_IMAGE=debian-buster
        - CONTEXT=syntax-test
        - TEST=syntax
      before_install: .travis/prepare.sh salt-test
      script: .travis/test.sh salt-test
      after_success: .travis/publish.sh docker
    - env:
        - DOCKER_IMAGE=ubuntu-bionic
        - CONTEXT=syntax-test
        - TEST=syntax
      before_install: .travis/prepare.sh salt-test
      script: .travis/test.sh salt-test
      after_success: .travis/publish.sh docker
    - env:
        - DOCKER_IMAGE=fedora-31
        - CONTEXT=syntax-test
        - TEST=syntax
      before_install: .travis/prepare.sh salt-test
      script: .travis/test.sh salt-test
# fixme try to merge together masterless with dry
    - stage: saltcheck
      name: "Saltcheck tests"
      before_install: .travis/prepare.sh salt-test
      script: .travis/test.sh salt-test
      env:
        - DOCKER_IMAGE=debian-buster
        - BASE_IMAGE_TAG=buster
        - SALTENV=base
        - CONTEXT=base
        - TEST=saltcheck
    - before_install: .travis/prepare.sh salt-test
      script: .travis/test.sh salt-test
      env:
        - DOCKER_IMAGE=debian-buster
        - BASE_IMAGE_TAG=buster
        - SALTENV=base
        - CONTEXT=gui
        - TEST=saltcheck
    - before_install: .travis/prepare.sh salt-test
      script: .travis/test.sh salt-test
      env:
        - DOCKER_IMAGE=debian-buster
        - BASE_IMAGE_TAG=buster
        - SALTENV=dev
        - CONTEXT=dev
        - TEST=saltcheck
    - before_install: .travis/prepare.sh salt-test
      script: .travis/test.sh salt-test
      env:
        - DOCKER_IMAGE=ubuntu-bionic
        - SALTENV=base
        - CONTEXT=base
        - TEST=saltcheck
    - before_install: .travis/prepare.sh salt-test
      script: .travis/test.sh salt-test
      env:
        - DOCKER_IMAGE=ubuntu-bionic
        - SALTENV=dev
        - CONTEXT=dev
        - TEST=saltcheck
    - stage: k8s
      name: "Kubernetes tests"
      env:
        - DOCKER_IMAGE=debian-buster
        - SALTENV=server
        - CONTEXT=k8s
        - CHANGE_MINIKUBE_NONE_USER=true # adjusts minikube permissions when driver=none
      before_install: .travis/prepare.sh salt-master-run-k8s
      script: .travis/test.sh salt-master-run-k8s
      after_success: .travis/publish.sh chart
      deploy:
        provider: pages
        skip_cleanup: true
        github_token: $GITHUB_TOKEN
        keep_history: true
        local_dir: $BUILD_DIR
        target-branch: $CHART_BRANCH
        verbose: true
        on:
          branch: master
